<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ghostlet — Market</title>
<style>
:root{--glow:#ff6aff}
body{margin:0;font-family:Segoe UI,Arial;background:linear-gradient(180deg,#0d0d1a,#1a1a2e);color:#eee}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:#242444;box-shadow:0 0 12px var(--glow);border-bottom:2px solid var(--glow);position:sticky;top:0;z-index:100}
.brand{color:var(--glow);font-weight:800;text-decoration:none}
nav button{background:var(--glow);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;margin-left:4px}
.container{max-width:1100px;margin:12px auto;padding:0 18px}
.h1{color:var(--glow);font-size:1.6rem;margin:12px 0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:12px}
.pack-card{background:linear-gradient(180deg,#20203a,#23233e);border-radius:12px;padding:14px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.6);cursor:pointer;transition:transform .15s,box-shadow .15s;border:2px solid transparent}
.pack-card:hover{transform:translateY(-6px) scale(1.01);border-color:rgba(255,106,255,0.12)}
.pack-thumb{width:120px;height:120px;object-fit:contain;margin:8px auto;display:block}
.pack-title{color:#fff;font-weight:700;margin-top:8px}
.pack-sub{color:#ccc;font-size:.9rem;margin-top:4px}
.pack-overlay{position:fixed;inset:0;background:rgba(4,6,20,0.85);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:9999}
.pack-popup{width:420px;max-width:calc(100% - 40px);aspect-ratio:1/1;background:radial-gradient(ellipse at 50% 10%, rgba(255,106,255,0.06), rgba(0,0,0,0.35));border-radius:14px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,0.6),0 0 18px #ff6aff33;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;user-select:none;overflow:visible}
.pack-graphic{width:60%;height:60%;object-fit:contain;transition:transform 700ms cubic-bezier(.2,.9,.2,1),opacity 350ms;z-index:5;pointer-events:none}
.blook-card{position:absolute;width:44%;height:44%;object-fit:contain;transform:scale(0) rotate(0deg);opacity:0;transition:transform 1000ms cubic-bezier(.18,.9,.2,1),opacity 400ms;z-index:10;pointer-events:none;filter:drop-shadow(0 8px 18px rgba(0,0,0,0.6));border-radius:8px;background:transparent}
.blook-card.reveal{transform:scale(1) rotate(720deg);opacity:1}
.blook-meta{position:absolute;bottom:14px;width:100%;text-align:center;color:#ddd;font-weight:700;z-index:11;font-family:"Segoe UI",Arial,sans-serif;text-shadow:0 2px 10px rgba(0,0,0,0.75);pointer-events:none}
.pack-hint{position:absolute;top:12px;right:16px;color:#ffb6ff;font-weight:700;z-index:12;font-family:"Segoe UI",Arial,sans-serif}
.toast{position:fixed;right:20px;bottom:20px;background:rgba(0,0,0,0.6);color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.6);font-weight:700;z-index:10000}
.hidden{display:none}
.flying-clone{position:fixed;z-index:20000;pointer-events:none;will-change:transform,width,height,left,top,opacity;transition:transform 700ms cubic-bezier(.2,.9,.2,1),opacity 420ms ease;transform-origin:center center;border-radius:8px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="topbar">
  <a class="brand" href="home.html">Ghostlet</a>
  <div>
    <button onclick="location.href='stats.html'">Stats</button>
    <button onclick="location.href='chat.html'">Chat</button>
    <button onclick="location.href='market.html'">Market</button>
    <button onclick="location.href='blooks.html'">Blooks</button>
    <button onclick="location.href='settings.html'">Settings</button>
    <button onclick="location.href='admin.html'">Admin</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">
  <div class="h1">Market — Packs</div>
  <div id="packsGrid" class="grid" aria-live="polite"></div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBLPQtq39tEcha66rw_ovWa5-I3Nl1qyos",
  authDomain: "ghostlet-98357.firebaseapp.com",
  projectId: "ghostlet-98357",
  storageBucket: "ghostlet-98357.appspot.com",
  messagingSenderId: "843012219969",
  appId: "1:843012219969:web:9e3037578726debf2212c0"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Logout
document.getElementById('logoutBtn').addEventListener('click', ()=> auth.signOut().then(()=> location.href='login.html'));

const PACKS = [
  {
    id: "og_pack",
    name: "OG Pack",
    image: "https://i.ibb.co/7rXxLxk/og-pack.png",
    blooks: [
      { id:"ghost_001", name:"Spencer", rarity:"Common", image:"https://i.ibb.co/0FQG7kF/spencer.png", weight:50 },
      { id:"cookie_001", name:"GhostRider", rarity:"Uncommon", image:"https://i.ibb.co/fdH9x8x/ghostrider.png", weight:25 },
      { id:"moon_001", name:"Invaser", rarity:"Rare", image:"https://i.ibb.co/NV8Lkk6/invaser.png", weight:15 }
    ]
  },
  {
    id: "spooky_pack",
    name: "Spooky Pack",
    image: "https://i.ibb.co/7rXxLxk/spooky-pack.png",
    blooks: [
      { id:"ghost_001", name:"Friendly Ghost", rarity:"Common", image:"https://i.ibb.co/0FQG7kF/friendly-ghost.png", weight:50 },
      { id:"cookie_001", name:"Haunted Cookie", rarity:"Uncommon", image:"https://i.ibb.co/fdH9x8x/hiaunted-cookie.png", weight:25 },
      { id:"moon_001", name:"Crescent Moon", rarity:"Rare", image:"https://i.ibb.co/NV8Lkk6/crescent-moion.png", weight:15 }
    ]
  },
  {
    id: "friendly_pack",
    name: "Friendly Pack",
    image: "https://i.ibb.co/Y7zV6J0/friendly-pack.png",
    blooks: [
      { id:"smile_001", name:"Smiley Ghost", rarity:"Common", image:"https://i.ibb.co/0FQG7kF/friendly-ghost.png", weight:60 },
      { id:"star_001", name:"Twinkle Star", rarity:"Uncommon", image:"https://i.ibb.co/FH7xW3B/twinkle-star.png", weight:30 },
      { id:"moon_002", name:"Full Moon", rarity:"Rare", image:"https://i.ibb.co/NV8Lkk6/crescent-moion.png", weight:10 }
    ]
  },
  {
    id: "mystery_pack",
    name: "Mystery Pack",
    image: "https://i.ibb.co/3Nv4gkv/mystery-pack.png",
    blooks: [
      { id:"phantom_001", name:"Phantom", rarity:"Common", image:"https://i.ibb.co/0FQG7kF/friendly-ghost.png", weight:40 },
      { id:"cookie_002", name:"Mystery Cookie", rarity:"Uncommon", image:"https://i.ibb.co/fdH9x8x/hiaunted-cookie.png", weight:35 },
      { id:"moon_003", name:"Eclipse Moon", rarity:"Rare", image:"https://i.ibb.co/NV8Lkk6/crescent-moion.png", weight:25 }
    ]
  }
];

// Auth guard
auth.onAuthStateChanged(user=>{
  if(!user) return window.location.href='login.html';
  const uid = user.uid;

  const packsGrid = document.getElementById('packsGrid');
  function renderPacks(){
    packsGrid.innerHTML = '';
    for(const p of PACKS){
      const div = document.createElement('div');
      div.className='pack-card';
      div.innerHTML = `<img class="pack-thumb" src="${p.image}" alt="${p.name}"><div class="pack-title">${p.name}</div><div class="pack-sub">${p.blooks.length} blooks inside</div>`;
      div.addEventListener('click', ()=> openPackPopup(p, uid));
      packsGrid.appendChild(div);
    }
  }
  renderPacks();

  // Weighted pick
  function pickWeighted(blooks){
    const weights = blooks.map(b => Math.max(1,b.weight||1));
    const sum = weights.reduce((a,b)=>a+b,0);
    let r=Math.random()*sum;
    for(let i=0;i<blooks.length;i++){
      r -= weights[i];
      if(r<=0) return blooks[i];
    }
    return blooks[blooks.length-1];
  }

  // Fly animation (unchanged)
  function flyToTargetFromRect(imgSrc, startRect, targetEl){
    return new Promise(resolve=>{
      const clone = document.createElement('img');
      clone.src = imgSrc; clone.className='flying-clone';
      document.body.appendChild(clone);
      clone.style.left = startRect.left+'px';
      clone.style.top = startRect.top+'px';
      clone.style.width = startRect.width+'px';
      clone.style.height = startRect.height+'px';
      const targetRect = targetEl.getBoundingClientRect();
      const dx = targetRect.left + targetRect.width/2 - (startRect.left+startRect.width/2);
      const dy = targetRect.top + targetRect.height/2 - (startRect.top+startRect.height/2);
      const endScale = Math.max(0.22,(targetRect.width/startRect.width)*0.9);
      requestAnimationFrame(()=>{
        clone.style.transition='transform 700ms cubic-bezier(.2,.9,.2,1), opacity 420ms ease';
        clone.style.transform=`translate(${dx}px, ${dy}px) scale(${endScale}) rotate(540deg)`;
        clone.style.opacity='0.95';
      });
      clone.addEventListener('transitionend', ()=>{
        clone.remove();
        resolve();
      }, {once:true});
    });
  }

  // Open pack popup
  function openPackPopup(pack, uid){
    const overlay=document.createElement('div'); overlay.className='pack-overlay';
    const popup=document.createElement('div'); popup.className='pack-popup'; overlay.appendChild(popup);
    const hint=document.createElement('div'); hint.className='pack-hint'; hint.textContent='Tap to open'; popup.appendChild(hint);

    const packImg=document.createElement('img'); packImg.className='pack-graphic'; packImg.src=pack.image||''; popup.appendChild(packImg);
    const blookImg=document.createElement('img'); blookImg.className='blook-card'; popup.appendChild(blookImg);
    const meta=document.createElement('div'); meta.className='blook-meta'; meta.style.display='none'; popup.appendChild(meta);

    document.body.appendChild(overlay);
    let state='idle', selected=null;

    overlay.addEventListener('click', async (e)=>{
      e.stopPropagation();
      if(state==='idle'){
        selected = pickWeighted(pack.blooks||[]);
        blookImg.src=selected.image||'';
        meta.style.display='block';
        meta.textContent=`${selected.name} • ${selected.rarity}`;
        packImg.classList.add('faded'); hint.textContent='Tap to continue';
        setTimeout(()=> blookImg.classList.add('reveal'),40);
        state='revealed';
        return;
      }
      if(state==='revealed'){
        // Save blook to user collection
        await db.collection('users').doc(uid).collection('blooks').add({
          id:selected.id, name:selected.name, image:selected.image, rarity:selected.rarity, count:1, openedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Increment packs opened
        await db.collection('users').doc(uid).collection('packsOpened').add({
          packId: pack.id, openedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        overlay.remove();
        state='closed';
      }
    });
  }
});
</script>
</body>
</html>
